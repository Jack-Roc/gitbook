# 1 Redis的五大数据类型实现原理

### Ⅰ简介

Redis的五大数据类型也称五大数据对象；Redis并没有直接使用这些结构来实现键值对数据库，而是使用这些结构构建了一个对象系统`redisObject`；这个对象系统包含了五大数据对象，字符串对象（`string`）、列表对象（`list`）、哈希对象（`hash`）、集合（`set`）对象和有序集合对象（`zset`）；而这五大对象的底层数据编码可以用命令OBJECT ENCODING来进行查看。

%accordion%redisObject结构%accordion%

```c
typedef struct redisObject{
     //类型
     unsigned type:4;
     //编码
     unsigned encoding:4;
     //指向底层数据结构的指针
     void *ptr;
     //引用计数
     int refcount;
     //记录最后一次被程序访问的时间
     unsigned lru:22;
 
}robj
```

%/accordion%

### Ⅱ

Redis是以`键值`对存储数据的，所以对象又分为`键对象`和`值对象`，即存储一个`key-value`键值对会创建两个对象，键对象和值对象。

键对象总是一个字符串对象，而值对象可以是五大对象中的任意一种。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108171346977.png)

- type属性存储的是对象的类型，也就是我们说的 string、list、hash、set、zset中的一种，可以使用命令 TYPE key 来查看。
- encoding属性记录了队形所使用的编码，即这个对象底层使用哪种数据结构实现。
- ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108171733868.png?)

而`每种类型的对象`都至少使用了`两种不同的编码`：

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108171958184.png?)

### Ⅲ

1. #### 字符串(String)

   字符串是Redis最基本的数据类型，不仅`所有key`都是字符串类型，`其它 几种数据类型 构成的元素`也是字符串。注意字符串的**长度不能超过512M**。

   一、编码

   ①int 编码：保存的是可以`用 long 类型表示的整数值`。

   ②raw 编码：保存`长度大于44字节的字符串`（redis3.2版本之前是39字节，之后是44字节）。

   ③embstr 编码：`保存长度小于44字节的字符串`（redis3.2版本之前是39字节，之后是44字节）

   ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108173534464.png)

   由上可以看出，int 编码是用来保存`整数值`，raw编码是用来保存`长字符串`，而embstr是用来保存`短字符串`。其实 embstr 编码是专门用来保存短字符串的一种优化编码，

   **raw 和 embstr 的区别**：embstr与raw`都使用 redisObject 和 sds 保存数据`，**区别在于**，embstr的使用`只分配一次内存空间`（因此`redisObject和sds是连续的`），而raw`需要分配两次内存空间`（`分别为redisObject和sds分配空间`）。因此与raw相比，**embstr的好处在于** `创建时少分配一次空间`，`删除时少释放一次空间`，`以及对象的所有数据连在一起`，`寻找方便`。而**embstr的坏处**也很明显，如果`字符串的长度增加需要重新分配内存时`，`整个redisObject和sds都需要重新分配空间`，**因此redis中的embstr实现为 只读**。

   二、编码的转换

   当 int 编码保存的值`不再是整数`，`或大小超过了long的范围时`，`自动转化为raw`。

   对于 embstr 编码，由于 Redis 没有对其编写任何的修改程序（`embstr 是只读的`），在`对embstr对象`进行               修改时，都会先转化为raw再进行修改，因此，只要是修改embstr对象，修改后的对象一定是raw的，无论是否达到了44个字节`。

2. #### 列表(List)

   Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素导列表的头部（左边）或者尾部（右边）。

   ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108185828714.png?)

   ##### 编码转换

   当同时`满足下面两个条件时`，`使用ziplist（压缩列表）编码`：

   1、列表`保存元素个数小于512个`

   2、`每个元素长度小于64字节`

   **不能满足这两个条件的时候使用 linkedlist 编码。**

3. ### 哈希(Hash)

   Redis hash 是一个键值对集合。

   Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。

   ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108191539295.png?)

   以上Demo中 hash 数据类型存储了包含用户脚本信息的用户对象。 Demo中我们使用了 Redis HMSET, HEGTALL 命令，cityhash 为键值。

   每个 hash 可以存储 232 - 1键值对（40多亿）。

   `hashtable 编码`的`哈希表对象`底层使用`字典数据结构`，哈希对象中的每个键值对都使用一个字典键值对。

   在前面介绍压缩列表时，我们介绍过压缩列表是Redis为了节省内存而开发的，是由一系列特殊编码的连续内存块组成的顺序型数据结构，`相对于字典数据结构`，`压缩列表 用于元素个数少、元素长度小的场景`。其`优势在于` `集中存储，节省空间`。

   ##### 编码转换

   和上面列表对象使用 ziplist 编码一样，当同时`满足下面两个条件时`，`使用ziplist（压缩列表）编码`：

   1、`列表`保存元素`个数小于512个`

   2、每个元素`长度小于64字节`

   `不能满足这两个条件的时候，使用 hashtable 编码`。第一个条件可以通过配置文件中的 set-max-intset-entries 进行修改。

4. ### 集合(Set)

   Redis的Set是string类型的无序集合。

   集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)。

   sadd 命令:添加一个string元素到,key对应的set集合中，成功返回1,如果元素以及在集合中返回0,key对应的set不存在返回错误。

   ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020010819224496.png?)

   以上Demo中 "BEIJING" 添加了两次，但根据集合内元素的唯一性，第二次插入的元素将被忽略。返回0

   集合中最大的成员数为 232 - 1 (4294967295, 每个集合可存储40多亿个成员)。

   ##### 编码转换

   当集合同时满`足以下两个条件时`，`使用 intset 编码`：

   1、集合对象中`所有元素都是整数`

   2、集合对象`所有元素数量不超过512`

   不能满足这两个条件的就使用 hashtable 编码。第二个条件可以通过配置文件的 set-max-intset-entries 进行配置。

5. ### 有序集合(Zset)

   Redis zset 和 set 一样也是string类型元素的集合,且不允许重复的成员。不同的是每个元素都会关联一个double类型的分数。redis正是通过分数来为集合中的成员进行从小到大的排序。

   zset的成员是唯一的,但分数(score)却可以重复。

   zadd 命令：添加元素到集合，元素在集合中存在则更新对应score

   ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200108193231279.png)

   ##### 编码转换

   当有序集合对象同时`满足以下两个条件时`，对象使用 `ziplist` 编码：

   1、保存的`元素数量小于128`；

   2、保存的`所有元素长度都小于64字节`。

   `不能满足`上面两个条件的使用 `skiplist` 编码。以上两个条件也可以通过Redis配置文件zset-max-ziplist-entries 选项和 zset-max-ziplist-value 进行修改。

















